package ast

import (
	"context"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/txpull/solgo"
	"go.uber.org/zap"
	"go.uber.org/zap/zapcore"
)

func TestResolver(t *testing.T) {
	config := zap.NewDevelopmentConfig()
	config.EncoderConfig.EncodeLevel = zapcore.CapitalColorLevelEncoder
	logger, err := config.Build()
	assert.NoError(t, err)

	// Replace the global logger.
	zap.ReplaceGlobals(logger)

	// Define multiple test cases
	testCases := []struct {
		name                 string
		sources              solgo.Sources
		expected             string
		unresolvedReferences int64
	}{
		{
			name: "Test Case 1 - Simple Test Contract",
			sources: solgo.Sources{
				SourceUnits: []solgo.SourceUnit{
					{
						Name:    "TestContract",
						Path:    "TestContract.sol",
						Content: "pragma solidity ^0.5.0; contract TestContract { uint256 public value; function setValue(uint256 _value) public { value = _value; } }",
					},
				},
				EntrySourceUnitName: "TestContract",
			},
			expected:             `{"id":1,"node_type":80,"entry_source_unit":2,"root":[{"id":2,"license":"unknown","exported_symbols":[{"id":2,"name":"TestContract","absolutePath":"TestContract.sol"}],"absolute_path":"TestContract.sol","name":"TestContract","node_type":1,"nodes":[{"id":4,"node_type":10,"src":{"id":5,"line":1,"column":0,"start":0,"end":22,"length":23,"parent_index":2},"literals":["pragma","solidity","^","0",".","5",".","0",";"]},{"id":6,"name":"TestContract","node_type":35,"src":{"id":0,"line":1,"column":24,"start":24,"end":131,"length":108,"parent_index":2},"abstract":false,"kind":36,"fully_implemented":true,"nodes":[{"id":8,"name":"value","is_constant":false,"is_state_variable":true,"node_type":44,"src":{"id":9,"line":1,"column":48,"start":48,"end":68,"length":21,"parent_index":6},"scope":6,"type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"visibility":3,"storage_location":1,"mutability":1,"type_name":{"id":10,"node_type":30,"src":{"id":11,"line":1,"column":48,"start":48,"end":54,"length":7,"parent_index":8},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0}},{"id":13,"name":"setValue","node_type":42,"kind":41,"src":{"id":14,"line":1,"column":70,"start":70,"end":129,"length":60,"parent_index":6},"body":{"id":22,"node_type":46,"kind":0,"src":{"id":23,"line":1,"column":111,"start":111,"end":129,"length":19,"parent_index":13},"implemented":true,"statements":[{"id":24,"node_type":81,"src":{"id":25,"line":1,"column":113,"start":113,"end":127,"length":15,"parent_index":22},"expression":{"id":26,"node_type":27,"src":{"id":27,"line":1,"column":113,"start":113,"end":126,"length":14,"parent_index":22},"operator":11,"left_expression":{"id":28,"node_type":16,"src":{"id":29,"line":1,"column":113,"start":113,"end":117,"length":5,"parent_index":26},"name":"value","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":8,"is_pure":false},"right_expression":{"id":30,"node_type":16,"src":{"id":31,"line":1,"column":121,"start":121,"end":126,"length":6,"parent_index":26},"name":"_value","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":30,"is_pure":false},"type_description":{"type_identifier":"t_uint256","type_string":"uint256"}}}]},"implemented":true,"visibility":3,"state_mutability":4,"virtual":false,"modifiers":[],"overrides":[],"parameters":{"id":15,"node_type":43,"src":{"id":16,"line":1,"column":88,"start":88,"end":101,"length":14,"parent_index":13},"parameters":[{"id":17,"node_type":44,"src":{"id":18,"line":1,"column":88,"start":88,"end":101,"length":14,"parent_index":15},"scope":13,"name":"_value","type_name":{"id":19,"node_type":30,"src":{"id":20,"line":1,"column":88,"start":88,"end":94,"length":7,"parent_index":17},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_uint256","type_string":"uint256"}]},"return_parameters":{"id":21,"node_type":43,"src":{"id":14,"line":1,"column":70,"start":70,"end":129,"length":60,"parent_index":13},"parameters":[],"parameter_types":null},"scope":6,"type_description":{"type_identifier":"t_function_$_t_uint256","type_string":"function(uint256)"}}],"linearized_base_contracts":[6],"base_contracts":[],"contract_dependencies":[]}],"src":{"id":3,"line":1,"column":24,"start":24,"end":131,"length":108,"parent_index":1}}],"comments":[]}`,
			unresolvedReferences: 0,
		},
		{
			name: "Test Case 2 - Contract with Inheritance",
			sources: solgo.Sources{
				SourceUnits: []solgo.SourceUnit{
					{
						Name:    "BaseContract",
						Path:    "BaseContract.sol",
						Content: "pragma solidity ^0.5.0; contract BaseContract { uint256 public baseValue; }",
					},
					{
						Name:    "DerivedContract",
						Path:    "DerivedContract.sol",
						Content: "pragma solidity ^0.5.0; import './BaseContract.sol'; contract DerivedContract is BaseContract { uint256 public derivedValue; }",
					},
				},
				EntrySourceUnitName: "DerivedContract",
			},
			expected:             `{"id":1,"node_type":80,"entry_source_unit":12,"root":[{"id":2,"license":"unknown","exported_symbols":[{"id":2,"name":"BaseContract","absolutePath":"BaseContract.sol"}],"absolute_path":"BaseContract.sol","name":"BaseContract","node_type":1,"nodes":[{"id":4,"node_type":10,"src":{"id":5,"line":1,"column":0,"start":0,"end":22,"length":23,"parent_index":2},"literals":["pragma","solidity","^","0",".","5",".","0",";"]},{"id":6,"name":"BaseContract","node_type":35,"src":{"id":0,"line":1,"column":24,"start":24,"end":74,"length":51,"parent_index":2},"abstract":false,"kind":36,"fully_implemented":true,"nodes":[{"id":8,"name":"baseValue","is_constant":false,"is_state_variable":true,"node_type":44,"src":{"id":9,"line":1,"column":48,"start":48,"end":72,"length":25,"parent_index":6},"scope":6,"type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"visibility":3,"storage_location":1,"mutability":1,"type_name":{"id":10,"node_type":30,"src":{"id":11,"line":1,"column":48,"start":48,"end":54,"length":7,"parent_index":8},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0}}],"linearized_base_contracts":[6],"base_contracts":[],"contract_dependencies":[]}],"src":{"id":3,"line":1,"column":24,"start":24,"end":74,"length":51,"parent_index":1}},{"id":12,"license":"unknown","exported_symbols":[{"id":12,"name":"DerivedContract","absolutePath":"DerivedContract.sol"},{"id":18,"name":"BaseContract","absolutePath":"BaseContract.sol'"}],"absolute_path":"DerivedContract.sol","name":"DerivedContract","node_type":1,"nodes":[{"id":16,"node_type":10,"src":{"id":17,"line":3,"column":0,"start":77,"end":99,"length":23,"parent_index":12},"literals":["pragma","solidity","^","0",".","5",".","0",";"]},{"id":18,"node_type":29,"src":{"id":0,"line":3,"column":24,"start":101,"end":128,"length":28,"parent_index":12},"absolute_path":"BaseContract.sol'","file":"'./BaseContract.sol'","scope":12,"unit_alias":"","source_unit":0},{"id":19,"name":"DerivedContract","node_type":35,"src":{"id":0,"line":3,"column":53,"start":130,"end":202,"length":73,"parent_index":12},"abstract":false,"kind":36,"fully_implemented":true,"nodes":[{"id":25,"name":"derivedValue","is_constant":false,"is_state_variable":true,"node_type":44,"src":{"id":26,"line":3,"column":96,"start":173,"end":200,"length":28,"parent_index":19},"scope":19,"type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"visibility":3,"storage_location":1,"mutability":1,"type_name":{"id":27,"node_type":30,"src":{"id":28,"line":3,"column":96,"start":173,"end":179,"length":7,"parent_index":25},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0}}],"linearized_base_contracts":[2,19,18],"base_contracts":[{"id":20,"node_type":62,"src":{"id":21,"line":3,"column":81,"start":158,"end":169,"length":12,"parent_index":19},"base_name":{"id":22,"node_type":52,"src":{"id":23,"line":3,"column":81,"start":158,"end":169,"length":12,"parent_index":19},"name":"BaseContract","referenced_declaration":2}}],"contract_dependencies":[2,18]}],"src":{"id":13,"line":3,"column":53,"start":130,"end":202,"length":73,"parent_index":1}}],"comments":[]}`,
			unresolvedReferences: 0,
		},
		{
			name: "Test Case 3 - Contract with Library",
			sources: solgo.Sources{
				SourceUnits: []solgo.SourceUnit{
					{
						Name:    "SafeMath",
						Path:    "SafeMath.sol",
						Content: "pragma solidity ^0.5.0; library SafeMath { function add(uint256 a, uint256 b) internal pure returns (uint256) { uint256 c = a + b; require(c >= a, 'SafeMath: addition overflow'); return c; } }",
					},
					{
						Name:    "TestContract",
						Path:    "TestContract.sol",
						Content: "pragma solidity ^0.5.0; import './SafeMath.sol'; contract TestContract { using SafeMath for uint256; uint256 public value; function increaseValue(uint256 _value) public { value = value.add(_value); } }",
					},
				},
				EntrySourceUnitName: "TestContract",
			},
			expected:             `{"id":1,"node_type":80,"entry_source_unit":56,"root":[{"id":2,"license":"unknown","exported_symbols":[{"id":2,"name":"SafeMath","absolutePath":"SafeMath.sol"}],"absolute_path":"SafeMath.sol","name":"SafeMath","node_type":1,"nodes":[{"id":4,"node_type":10,"src":{"id":5,"line":1,"column":0,"start":0,"end":22,"length":23,"parent_index":2},"literals":["pragma","solidity","^","0",".","5",".","0",";"]},{"id":6,"name":"SafeMath","node_type":35,"src":{"id":0,"line":1,"column":24,"start":24,"end":191,"length":168,"parent_index":2},"abstract":false,"kind":37,"fully_implemented":true,"nodes":[{"id":8,"name":"add","node_type":42,"kind":41,"src":{"id":9,"line":1,"column":43,"start":43,"end":189,"length":147,"parent_index":6},"body":{"id":26,"node_type":46,"kind":0,"src":{"id":27,"line":1,"column":110,"start":110,"end":189,"length":80,"parent_index":8},"implemented":true,"statements":[{"id":28,"node_type":44,"src":{"id":29,"line":1,"column":112,"start":112,"end":129,"length":18,"parent_index":26},"assignments":[30],"declarations":[{"is_constant":false,"id":30,"state_mutability":1,"name":"c","node_type":44,"scope":26,"src":{"id":31,"line":1,"column":112,"start":112,"end":120,"length":9,"parent_index":28},"is_state_variable":false,"storage_location":1,"type_name":{"id":32,"node_type":30,"src":{"id":33,"line":1,"column":112,"start":112,"end":118,"length":7,"parent_index":30},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"visibility":1}],"initial_value":{"id":34,"is_constant":false,"is_pure":false,"node_type":19,"src":{"id":35,"line":1,"column":124,"start":124,"end":128,"length":5,"parent_index":28},"operator":1,"left_expression":{"id":36,"node_type":16,"src":{"id":37,"line":1,"column":124,"start":124,"end":124,"length":1,"parent_index":34},"name":"a","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":36,"is_pure":false},"right_expression":{"id":38,"node_type":16,"src":{"id":39,"line":1,"column":128,"start":128,"end":128,"length":1,"parent_index":34},"name":"b","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":38,"is_pure":false}}},{"id":40,"node_type":24,"kind":24,"src":{"id":41,"line":1,"column":131,"start":131,"end":176,"length":46,"parent_index":26},"argument_types":[{"type_identifier":"t_uint256","type_string":"uint256"},{"type_identifier":"t_string_literal","type_string":"literal_string 'SafeMath: addition overflow'"}],"arguments":[{"id":42,"is_constant":false,"is_pure":false,"node_type":19,"src":{"id":43,"line":1,"column":139,"start":139,"end":144,"length":6,"parent_index":40},"operator":8,"left_expression":{"id":44,"node_type":16,"src":{"id":45,"line":1,"column":139,"start":139,"end":139,"length":1,"parent_index":42},"name":"c","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":28,"is_pure":false},"right_expression":{"id":46,"node_type":16,"src":{"id":47,"line":1,"column":144,"start":144,"end":144,"length":1,"parent_index":42},"name":"a","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":46,"is_pure":false}},{"id":48,"node_type":17,"kind":50,"value":"'SafeMath: addition overflow'","hex_value":"27536166654d6174683a206164646974696f6e206f766572666c6f7727","src":{"id":49,"line":1,"column":147,"start":147,"end":175,"length":29,"parent_index":40},"type_description":{"type_identifier":"t_string_literal","type_string":"literal_string 'SafeMath: addition overflow'"},"overloaded_declarations":[],"referenced_declaration":0,"is_pure":true,"argument_types":[{"type_identifier":"t_uint256","type_string":"uint256"}]}],"expression":{"id":50,"node_type":16,"src":{"id":51,"line":1,"column":131,"start":131,"end":137,"length":7,"parent_index":40},"name":"require","type_description":{"type_identifier":"t_function_$_t_uint256$$_t_string_literal","type_string":"function(uint256,literal_string 'SafeMath: addition overflow')"},"overloaded_declarations":[],"referenced_declaration":0,"is_pure":false,"argument_types":[{"type_identifier":"t_uint256","type_string":"uint256"},{"type_identifier":"t_string_literal","type_string":"literal_string 'SafeMath: addition overflow'"}]},"type_description":{"type_identifier":"t_function_$_t_uint256$_t_string_literal$","type_string":"function(uint256,string memory)"}},{"id":52,"node_type":47,"src":{"id":53,"line":1,"column":179,"start":179,"end":187,"length":9,"parent_index":8},"function_return_parameters":8,"expression":{"id":54,"node_type":16,"src":{"id":55,"line":1,"column":186,"start":186,"end":186,"length":1,"parent_index":26},"name":"c","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":28,"is_pure":false}}]},"implemented":true,"visibility":1,"state_mutability":6,"virtual":false,"modifiers":[],"overrides":[],"parameters":{"id":10,"node_type":43,"src":{"id":11,"line":1,"column":56,"start":56,"end":75,"length":20,"parent_index":8},"parameters":[{"id":12,"node_type":44,"src":{"id":13,"line":1,"column":56,"start":56,"end":64,"length":9,"parent_index":10},"scope":8,"name":"a","type_name":{"id":14,"node_type":30,"src":{"id":15,"line":1,"column":56,"start":56,"end":62,"length":7,"parent_index":12},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1},{"id":16,"node_type":44,"src":{"id":17,"line":1,"column":67,"start":67,"end":75,"length":9,"parent_index":10},"scope":8,"name":"b","type_name":{"id":18,"node_type":30,"src":{"id":19,"line":1,"column":67,"start":67,"end":73,"length":7,"parent_index":16},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_uint256","type_string":"uint256"},{"type_identifier":"t_uint256","type_string":"uint256"}]},"return_parameters":{"id":20,"node_type":43,"src":{"id":21,"line":1,"column":101,"start":101,"end":107,"length":7,"parent_index":8},"parameters":[{"id":22,"node_type":44,"src":{"id":23,"line":1,"column":101,"start":101,"end":107,"length":7,"parent_index":20},"scope":8,"name":"","type_name":{"id":24,"node_type":30,"src":{"id":25,"line":1,"column":101,"start":101,"end":107,"length":7,"parent_index":22},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_uint256","type_string":"uint256"}]},"scope":6,"type_description":{"type_identifier":"t_function_$_t_uint256$$_t_uint256","type_string":"function(uint256,uint256)"}}],"linearized_base_contracts":[6],"base_contracts":[],"contract_dependencies":[],"scope":2}],"src":{"id":3,"line":1,"column":24,"start":24,"end":191,"length":168,"parent_index":1}},{"id":56,"license":"unknown","exported_symbols":[{"id":56,"name":"TestContract","absolutePath":"TestContract.sol"},{"id":62,"name":"SafeMath","absolutePath":"SafeMath.sol'"}],"absolute_path":"TestContract.sol","name":"TestContract","node_type":1,"nodes":[{"id":60,"node_type":10,"src":{"id":61,"line":3,"column":0,"start":194,"end":216,"length":23,"parent_index":56},"literals":["pragma","solidity","^","0",".","5",".","0",";"]},{"id":62,"node_type":29,"src":{"id":0,"line":3,"column":24,"start":218,"end":241,"length":24,"parent_index":56},"absolute_path":"SafeMath.sol'","file":"'./SafeMath.sol'","scope":56,"unit_alias":"","source_unit":0},{"id":63,"name":"TestContract","node_type":35,"src":{"id":0,"line":3,"column":49,"start":243,"end":394,"length":152,"parent_index":56},"abstract":false,"kind":36,"fully_implemented":true,"nodes":[{"id":65,"node_type":51,"src":{"id":66,"line":3,"column":0,"start":267,"end":293,"length":27,"parent_index":63},"type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"type_name":{"id":67,"node_type":30,"src":{"id":68,"line":3,"column":92,"start":286,"end":292,"length":7,"parent_index":65},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"library_name":{"id":69,"node_type":52,"src":{"id":70,"line":3,"column":0,"start":273,"end":280,"length":8,"parent_index":65},"name":"SafeMath","referenced_declaration":2}},{"id":72,"name":"value","is_constant":false,"is_state_variable":true,"node_type":44,"src":{"id":73,"line":3,"column":101,"start":295,"end":315,"length":21,"parent_index":63},"scope":63,"type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"visibility":3,"storage_location":1,"mutability":1,"type_name":{"id":74,"node_type":30,"src":{"id":75,"line":3,"column":101,"start":295,"end":301,"length":7,"parent_index":72},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0}},{"id":77,"name":"increaseValue","node_type":42,"kind":41,"src":{"id":78,"line":3,"column":123,"start":317,"end":392,"length":76,"parent_index":63},"body":{"id":86,"node_type":46,"kind":0,"src":{"id":87,"line":3,"column":169,"start":363,"end":392,"length":30,"parent_index":77},"implemented":true,"statements":[{"id":88,"node_type":81,"src":{"id":89,"line":3,"column":171,"start":365,"end":390,"length":26,"parent_index":86},"expression":{"id":90,"node_type":27,"src":{"id":91,"line":3,"column":171,"start":365,"end":389,"length":25,"parent_index":86},"operator":11,"left_expression":{"id":92,"node_type":16,"src":{"id":93,"line":3,"column":171,"start":365,"end":369,"length":5,"parent_index":90},"name":"value","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":72,"is_pure":false},"right_expression":{"id":94,"node_type":24,"kind":24,"src":{"id":95,"line":3,"column":179,"start":373,"end":389,"length":17,"parent_index":90},"argument_types":[{"type_identifier":"t_uint256","type_string":"uint256"}],"arguments":[{"id":96,"node_type":16,"src":{"id":97,"line":3,"column":189,"start":383,"end":388,"length":6,"parent_index":94},"name":"_value","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":96,"is_pure":false}],"expression":{"id":98,"is_constant":false,"is_l_value":false,"is_pure":false,"l_value_requested":false,"node_type":23,"src":{"id":99,"line":3,"column":179,"start":373,"end":381,"length":9,"parent_index":94},"expression":{"id":100,"node_type":16,"src":{"id":101,"line":3,"column":179,"start":373,"end":377,"length":5,"parent_index":98},"name":"value","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":72,"is_pure":false},"member_name":"add","argument_types":[{"type_identifier":"t_uint256","type_string":"uint256"}],"type_description":{"type_identifier":"t_uint256","type_string":"uint256"}},"type_description":{"type_identifier":"t_function_$_t_uint256$","type_string":"function(uint256)"}},"type_description":{"type_identifier":"t_uint256","type_string":"uint256"}}}]},"implemented":true,"visibility":3,"state_mutability":4,"virtual":false,"modifiers":[],"overrides":[],"parameters":{"id":79,"node_type":43,"src":{"id":80,"line":3,"column":146,"start":340,"end":353,"length":14,"parent_index":77},"parameters":[{"id":81,"node_type":44,"src":{"id":82,"line":3,"column":146,"start":340,"end":353,"length":14,"parent_index":79},"scope":77,"name":"_value","type_name":{"id":83,"node_type":30,"src":{"id":84,"line":3,"column":146,"start":340,"end":346,"length":7,"parent_index":81},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_uint256","type_string":"uint256"}]},"return_parameters":{"id":85,"node_type":43,"src":{"id":78,"line":3,"column":123,"start":317,"end":392,"length":76,"parent_index":77},"parameters":[],"parameter_types":null},"scope":63,"type_description":{"type_identifier":"t_function_$_t_uint256","type_string":"function(uint256)"}}],"linearized_base_contracts":[63,62],"base_contracts":[],"contract_dependencies":[62]}],"src":{"id":57,"line":3,"column":49,"start":243,"end":394,"length":152,"parent_index":1}}],"comments":[]}`,
			unresolvedReferences: 0,
		},
		{
			name: "Test Case 4 - Contract with Interface",
			sources: solgo.Sources{
				SourceUnits: []solgo.SourceUnit{
					{
						Name:    "IERC20",
						Path:    "IERC20.sol",
						Content: "pragma solidity ^0.5.0; interface IERC20 { function totalSupply() external view returns (uint256); function balanceOf(address account) external view returns (uint256); function transfer(address recipient, uint256 amount) external returns (bool); }",
					},
					{
						Name:    "TestContract",
						Path:    "TestContract.sol",
						Content: "pragma solidity ^0.5.0; import './IERC20.sol'; contract TestContract is IERC20 { uint256 public totalSupply; mapping(address => uint256) private _balances; function balanceOf(address account) public view returns (uint256) { return _balances[account]; } function transfer(address recipient, uint256 amount) public returns (bool) { _balances[msg.sender] -= amount; _balances[recipient] += amount; return true; } }",
					},
				},
				EntrySourceUnitName: "TestContract",
			},
			expected:             `{"id":1,"node_type":80,"entry_source_unit":60,"root":[{"id":2,"license":"unknown","exported_symbols":[{"id":2,"name":"IERC20","absolutePath":"IERC20.sol"}],"absolute_path":"IERC20.sol","name":"IERC20","node_type":1,"nodes":[{"id":4,"node_type":10,"src":{"id":5,"line":1,"column":0,"start":0,"end":22,"length":23,"parent_index":2},"literals":["pragma","solidity","^","0",".","5",".","0",";"]},{"id":7,"name":"IERC20","node_type":35,"src":{"id":0,"line":1,"column":24,"start":24,"end":246,"length":223,"parent_index":2},"abstract":false,"kind":37,"fully_implemented":true,"nodes":[{"id":9,"name":"totalSupply","node_type":42,"kind":41,"src":{"id":10,"line":1,"column":43,"start":43,"end":97,"length":55,"parent_index":7},"body":{"id":23,"node_type":46,"kind":0,"src":{"id":10,"line":1,"column":43,"start":43,"end":97,"length":55,"parent_index":9},"implemented":false,"statements":[]},"implemented":false,"visibility":4,"state_mutability":5,"virtual":false,"modifiers":[],"overrides":[],"parameters":{"id":11,"node_type":43,"src":{"id":12,"line":1,"column":89,"start":89,"end":95,"length":7,"parent_index":9},"parameters":[{"id":13,"node_type":44,"src":{"id":14,"line":1,"column":89,"start":89,"end":95,"length":7,"parent_index":11},"scope":9,"name":"","type_name":{"id":15,"node_type":30,"src":{"id":16,"line":1,"column":89,"start":89,"end":95,"length":7,"parent_index":13},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_uint256","type_string":"uint256"}]},"return_parameters":{"id":17,"node_type":43,"src":{"id":18,"line":1,"column":89,"start":89,"end":95,"length":7,"parent_index":9},"parameters":[{"id":19,"node_type":44,"src":{"id":20,"line":1,"column":89,"start":89,"end":95,"length":7,"parent_index":17},"scope":9,"name":"","type_name":{"id":21,"node_type":30,"src":{"id":22,"line":1,"column":89,"start":89,"end":95,"length":7,"parent_index":19},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_uint256","type_string":"uint256"}]},"scope":7,"type_description":{"type_identifier":"t_function_$_t_uint256","type_string":"function(uint256)"}},{"id":25,"name":"balanceOf","node_type":42,"kind":41,"src":{"id":26,"line":1,"column":99,"start":99,"end":166,"length":68,"parent_index":7},"body":{"id":39,"node_type":46,"kind":0,"src":{"id":26,"line":1,"column":99,"start":99,"end":166,"length":68,"parent_index":25},"implemented":false,"statements":[]},"implemented":false,"visibility":4,"state_mutability":5,"virtual":false,"modifiers":[],"overrides":[],"parameters":{"id":27,"node_type":43,"src":{"id":28,"line":1,"column":118,"start":118,"end":132,"length":15,"parent_index":25},"parameters":[{"id":29,"node_type":44,"src":{"id":30,"line":1,"column":118,"start":118,"end":132,"length":15,"parent_index":27},"scope":25,"name":"account","type_name":{"id":31,"node_type":30,"src":{"id":32,"line":1,"column":118,"start":118,"end":124,"length":7,"parent_index":29},"name":"address","type_description":{"type_identifier":"t_address","type_string":"address"},"state_mutability":4,"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":4}],"parameter_types":[{"type_identifier":"t_address","type_string":"address"}]},"return_parameters":{"id":33,"node_type":43,"src":{"id":34,"line":1,"column":158,"start":158,"end":164,"length":7,"parent_index":25},"parameters":[{"id":35,"node_type":44,"src":{"id":36,"line":1,"column":158,"start":158,"end":164,"length":7,"parent_index":33},"scope":25,"name":"","type_name":{"id":37,"node_type":30,"src":{"id":38,"line":1,"column":158,"start":158,"end":164,"length":7,"parent_index":35},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_uint256","type_string":"uint256"}]},"scope":7,"type_description":{"type_identifier":"t_function_$_t_address","type_string":"function(address)"}},{"id":41,"name":"transfer","node_type":42,"kind":41,"src":{"id":42,"line":1,"column":168,"start":168,"end":244,"length":77,"parent_index":7},"body":{"id":59,"node_type":46,"kind":0,"src":{"id":42,"line":1,"column":168,"start":168,"end":244,"length":77,"parent_index":41},"implemented":false,"statements":[]},"implemented":false,"visibility":4,"state_mutability":4,"virtual":false,"modifiers":[],"overrides":[],"parameters":{"id":43,"node_type":43,"src":{"id":44,"line":1,"column":186,"start":186,"end":218,"length":33,"parent_index":41},"parameters":[{"id":45,"node_type":44,"src":{"id":46,"line":1,"column":186,"start":186,"end":202,"length":17,"parent_index":43},"scope":41,"name":"recipient","type_name":{"id":47,"node_type":30,"src":{"id":48,"line":1,"column":186,"start":186,"end":192,"length":7,"parent_index":45},"name":"address","type_description":{"type_identifier":"t_address","type_string":"address"},"state_mutability":4,"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":4},{"id":49,"node_type":44,"src":{"id":50,"line":1,"column":205,"start":205,"end":218,"length":14,"parent_index":43},"scope":41,"name":"amount","type_name":{"id":51,"node_type":30,"src":{"id":52,"line":1,"column":205,"start":205,"end":211,"length":7,"parent_index":49},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_address","type_string":"address"},{"type_identifier":"t_uint256","type_string":"uint256"}]},"return_parameters":{"id":53,"node_type":43,"src":{"id":54,"line":1,"column":239,"start":239,"end":242,"length":4,"parent_index":41},"parameters":[{"id":55,"node_type":44,"src":{"id":56,"line":1,"column":239,"start":239,"end":242,"length":4,"parent_index":53},"scope":41,"name":"","type_name":{"id":57,"node_type":30,"src":{"id":58,"line":1,"column":239,"start":239,"end":242,"length":4,"parent_index":55},"name":"bool","type_description":{"type_identifier":"t_bool","type_string":"bool"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_bool","type_string":"bool"}]},"scope":7,"type_description":{"type_identifier":"t_function_$_t_address$$_t_uint256","type_string":"function(address,uint256)"}}],"linearized_base_contracts":[7],"base_contracts":null,"contract_dependencies":null}],"src":{"id":3,"line":1,"column":24,"start":24,"end":246,"length":223,"parent_index":1}},{"id":60,"license":"unknown","exported_symbols":[{"id":60,"name":"TestContract","absolutePath":"TestContract.sol"},{"id":66,"name":"IERC20","absolutePath":"IERC20.sol'"}],"absolute_path":"TestContract.sol","name":"TestContract","node_type":1,"nodes":[{"id":64,"node_type":10,"src":{"id":65,"line":3,"column":0,"start":249,"end":271,"length":23,"parent_index":60},"literals":["pragma","solidity","^","0",".","5",".","0",";"]},{"id":66,"node_type":29,"src":{"id":0,"line":3,"column":24,"start":273,"end":294,"length":22,"parent_index":60},"absolute_path":"IERC20.sol'","file":"'./IERC20.sol'","scope":60,"unit_alias":"","source_unit":0},{"id":67,"name":"TestContract","node_type":35,"src":{"id":0,"line":3,"column":47,"start":296,"end":659,"length":364,"parent_index":60},"abstract":false,"kind":36,"fully_implemented":true,"nodes":[{"id":73,"name":"totalSupply","is_constant":false,"is_state_variable":true,"node_type":44,"src":{"id":74,"line":3,"column":81,"start":330,"end":356,"length":27,"parent_index":67},"scope":67,"type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"visibility":3,"storage_location":1,"mutability":1,"type_name":{"id":75,"node_type":30,"src":{"id":76,"line":3,"column":81,"start":330,"end":336,"length":7,"parent_index":73},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0}},{"id":78,"name":"_balances","is_constant":false,"is_state_variable":true,"node_type":44,"src":{"id":79,"line":3,"column":109,"start":358,"end":403,"length":46,"parent_index":67},"scope":67,"type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"},"visibility":2,"storage_location":1,"mutability":1,"type_name":{"id":80,"node_type":0,"src":{"id":81,"line":3,"column":109,"start":358,"end":384,"length":27,"parent_index":78},"type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"},"key_type":{"id":82,"node_type":30,"src":{"id":83,"line":3,"column":117,"start":366,"end":372,"length":7,"parent_index":80},"name":"address","type_description":{"type_identifier":"t_address","type_string":"address"},"referenced_declaration":0},"value_type":{"id":84,"node_type":30,"src":{"id":85,"line":3,"column":128,"start":377,"end":383,"length":7,"parent_index":80},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"referenced_declaration":0}},{"id":87,"name":"balanceOf","node_type":42,"kind":41,"src":{"id":88,"line":3,"column":156,"start":405,"end":500,"length":96,"parent_index":67},"body":{"id":101,"node_type":46,"kind":0,"src":{"id":102,"line":3,"column":222,"start":471,"end":500,"length":30,"parent_index":87},"implemented":true,"statements":[{"id":103,"node_type":47,"src":{"id":104,"line":3,"column":224,"start":473,"end":498,"length":26,"parent_index":87},"function_return_parameters":87,"expression":{"id":105,"node_type":22,"src":{"id":106,"line":3,"column":231,"start":480,"end":497,"length":18,"parent_index":101},"index_expression":{"id":107,"node_type":16,"src":{"id":108,"line":3,"column":231,"start":480,"end":488,"length":9,"parent_index":105},"name":"_balances","type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"},"overloaded_declarations":[],"referenced_declaration":78,"is_pure":false},"base_expression":{"id":109,"node_type":16,"src":{"id":110,"line":3,"column":241,"start":490,"end":496,"length":7,"parent_index":105},"name":"account","type_description":{"type_identifier":"t_address","type_string":"address"},"overloaded_declarations":[],"referenced_declaration":109,"is_pure":false},"type_descriptions":[{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"},{"type_identifier":"t_address","type_string":"address"}],"type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"}}}]},"implemented":true,"visibility":3,"state_mutability":5,"virtual":false,"modifiers":[],"overrides":[],"parameters":{"id":89,"node_type":43,"src":{"id":90,"line":3,"column":175,"start":424,"end":438,"length":15,"parent_index":87},"parameters":[{"id":91,"node_type":44,"src":{"id":92,"line":3,"column":175,"start":424,"end":438,"length":15,"parent_index":89},"scope":87,"name":"account","type_name":{"id":93,"node_type":30,"src":{"id":94,"line":3,"column":175,"start":424,"end":430,"length":7,"parent_index":91},"name":"address","type_description":{"type_identifier":"t_address","type_string":"address"},"state_mutability":4,"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":4}],"parameter_types":[{"type_identifier":"t_address","type_string":"address"}]},"return_parameters":{"id":95,"node_type":43,"src":{"id":96,"line":3,"column":213,"start":462,"end":468,"length":7,"parent_index":87},"parameters":[{"id":97,"node_type":44,"src":{"id":98,"line":3,"column":213,"start":462,"end":468,"length":7,"parent_index":95},"scope":87,"name":"","type_name":{"id":99,"node_type":30,"src":{"id":100,"line":3,"column":213,"start":462,"end":468,"length":7,"parent_index":97},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_uint256","type_string":"uint256"}]},"scope":67,"type_description":{"type_identifier":"t_function_$_t_address","type_string":"function(address)"}},{"id":112,"name":"transfer","node_type":42,"kind":41,"src":{"id":113,"line":3,"column":253,"start":502,"end":657,"length":156,"parent_index":67},"body":{"id":130,"node_type":46,"kind":0,"src":{"id":131,"line":3,"column":328,"start":577,"end":657,"length":81,"parent_index":112},"implemented":true,"statements":[{"id":132,"node_type":81,"src":{"id":133,"line":3,"column":330,"start":579,"end":610,"length":32,"parent_index":130},"expression":{"id":134,"node_type":27,"src":{"id":135,"line":3,"column":330,"start":579,"end":609,"length":31,"parent_index":130},"operator":14,"left_expression":{"id":136,"node_type":22,"src":{"id":137,"line":3,"column":330,"start":579,"end":599,"length":21,"parent_index":134},"index_expression":{"id":138,"node_type":16,"src":{"id":139,"line":3,"column":330,"start":579,"end":587,"length":9,"parent_index":136},"name":"_balances","type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"},"overloaded_declarations":[],"referenced_declaration":78,"is_pure":false},"base_expression":{"id":140,"is_constant":false,"is_l_value":false,"is_pure":false,"l_value_requested":false,"node_type":23,"src":{"id":141,"line":3,"column":340,"start":589,"end":598,"length":10,"parent_index":136},"expression":{"id":142,"node_type":16,"src":{"id":143,"line":3,"column":340,"start":589,"end":591,"length":3,"parent_index":140},"name":"msg","type_description":{"type_identifier":"t_magic_message","type_string":"msg"},"overloaded_declarations":[],"referenced_declaration":0,"is_pure":false},"member_name":"sender","argument_types":[],"type_description":{"type_identifier":"t_address","type_string":"address"}},"type_descriptions":[{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"},{"type_identifier":"t_address","type_string":"address"}],"type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"}},"right_expression":{"id":144,"node_type":16,"src":{"id":145,"line":3,"column":355,"start":604,"end":609,"length":6,"parent_index":134},"name":"amount","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":144,"is_pure":false},"type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"}}},{"id":146,"node_type":81,"src":{"id":147,"line":3,"column":363,"start":612,"end":642,"length":31,"parent_index":130},"expression":{"id":148,"node_type":27,"src":{"id":149,"line":3,"column":363,"start":612,"end":641,"length":30,"parent_index":130},"operator":13,"left_expression":{"id":150,"node_type":22,"src":{"id":151,"line":3,"column":363,"start":612,"end":631,"length":20,"parent_index":148},"index_expression":{"id":152,"node_type":16,"src":{"id":153,"line":3,"column":363,"start":612,"end":620,"length":9,"parent_index":150},"name":"_balances","type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"},"overloaded_declarations":[],"referenced_declaration":78,"is_pure":false},"base_expression":{"id":154,"node_type":16,"src":{"id":155,"line":3,"column":373,"start":622,"end":630,"length":9,"parent_index":150},"name":"recipient","type_description":{"type_identifier":"t_address","type_string":"address"},"overloaded_declarations":[],"referenced_declaration":154,"is_pure":false},"type_descriptions":[{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"},{"type_identifier":"t_address","type_string":"address"}],"type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"}},"right_expression":{"id":156,"node_type":16,"src":{"id":157,"line":3,"column":387,"start":636,"end":641,"length":6,"parent_index":148},"name":"amount","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"overloaded_declarations":[],"referenced_declaration":156,"is_pure":false},"type_description":{"type_identifier":"t_mapping_$t_address_$t_uint256$","type_string":"mapping(address =\u003e uint256)"}}},{"id":158,"node_type":47,"src":{"id":159,"line":3,"column":395,"start":644,"end":655,"length":12,"parent_index":112},"function_return_parameters":112,"expression":{"id":160,"node_type":17,"kind":61,"value":"true","hex_value":"74727565","src":{"id":161,"line":3,"column":402,"start":651,"end":654,"length":4,"parent_index":130},"type_description":{"type_identifier":"t_bool","type_string":"bool"},"overloaded_declarations":[],"referenced_declaration":0,"is_pure":true}}]},"implemented":true,"visibility":3,"state_mutability":4,"virtual":false,"modifiers":[],"overrides":[],"parameters":{"id":114,"node_type":43,"src":{"id":115,"line":3,"column":271,"start":520,"end":552,"length":33,"parent_index":112},"parameters":[{"id":116,"node_type":44,"src":{"id":117,"line":3,"column":271,"start":520,"end":536,"length":17,"parent_index":114},"scope":112,"name":"recipient","type_name":{"id":118,"node_type":30,"src":{"id":119,"line":3,"column":271,"start":520,"end":526,"length":7,"parent_index":116},"name":"address","type_description":{"type_identifier":"t_address","type_string":"address"},"state_mutability":4,"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":4},{"id":120,"node_type":44,"src":{"id":121,"line":3,"column":290,"start":539,"end":552,"length":14,"parent_index":114},"scope":112,"name":"amount","type_name":{"id":122,"node_type":30,"src":{"id":123,"line":3,"column":290,"start":539,"end":545,"length":7,"parent_index":120},"name":"uint256","type_description":{"type_identifier":"t_uint256","type_string":"uint256"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_address","type_string":"address"},{"type_identifier":"t_uint256","type_string":"uint256"}]},"return_parameters":{"id":124,"node_type":43,"src":{"id":125,"line":3,"column":322,"start":571,"end":574,"length":4,"parent_index":112},"parameters":[{"id":126,"node_type":44,"src":{"id":127,"line":3,"column":322,"start":571,"end":574,"length":4,"parent_index":124},"scope":112,"name":"","type_name":{"id":128,"node_type":30,"src":{"id":129,"line":3,"column":322,"start":571,"end":574,"length":4,"parent_index":126},"name":"bool","type_description":{"type_identifier":"t_bool","type_string":"bool"},"referenced_declaration":0},"storage_location":2,"visibility":1,"state_mutability":1}],"parameter_types":[{"type_identifier":"t_bool","type_string":"bool"}]},"scope":67,"type_description":{"type_identifier":"t_function_$_t_address$$_t_uint256","type_string":"function(address,uint256)"}}],"linearized_base_contracts":[2,67,66],"base_contracts":[{"id":68,"node_type":62,"src":{"id":69,"line":3,"column":72,"start":321,"end":326,"length":6,"parent_index":67},"base_name":{"id":70,"node_type":52,"src":{"id":71,"line":3,"column":72,"start":321,"end":326,"length":6,"parent_index":67},"name":"IERC20","referenced_declaration":2}}],"contract_dependencies":[2,66]}],"src":{"id":61,"line":3,"column":47,"start":296,"end":659,"length":364,"parent_index":1}}],"comments":[]}`,
			unresolvedReferences: 0,
		},
	}

	for _, testCase := range testCases {
		t.Run(testCase.name, func(t *testing.T) {
			parser, err := solgo.NewParserFromSources(context.TODO(), testCase.sources)
			assert.NoError(t, err)
			assert.NotNil(t, parser)

			astBuilder := NewAstBuilder(
				parser.GetParser(),
				parser.GetSources(),
			)

			err = parser.RegisterListener(solgo.ListenerAst, astBuilder)
			assert.NoError(t, err)

			syntaxErrs := parser.Parse()
			assert.Empty(t, syntaxErrs)

			errs := astBuilder.ResolveReferences()
			assert.Equal(t, int(testCase.unresolvedReferences), len(errs))

			for _, sourceUnit := range astBuilder.GetRoot().GetSourceUnits() {
				prettyJson, err := astBuilder.ToPrettyJSON(sourceUnit)
				assert.NoError(t, err)
				assert.NotEmpty(t, prettyJson)
			}

			prettyJson, err := astBuilder.ToPrettyJSON(astBuilder.GetRoot())
			assert.NoError(t, err)
			assert.NotEmpty(t, prettyJson)

			astJson, err := astBuilder.ToJSON()
			assert.NoError(t, err)
			assert.NotEmpty(t, astJson)

			assert.Equal(t, testCase.expected, string(astJson))
		})
	}
}
